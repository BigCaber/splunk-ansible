---
- name: Check if UDS file exists
  stat:
    path: "/opt/splunkforwarder/var/run/splunk/cli.socket"
  register: socket_file

- name: UDS flag check
  debug:
    msg: "UDS is marked as enabled, but cli.socket file is missing or empty"
  when:
    - splunk.splunk_http_enabled|bool == false
    - not socket_file.stat.exists or (socket_file.stat.exists and socket_file.stat.size == 0)

- name: Configure to set Mgmt Mode as auto (Allows UDS)
  ini_file:
    dest: "{{ splunk.home }}/etc/system/local/server.conf"
    option: "mgmtMode"
    section: "httpServer"
    value: "auto"
    owner: "{{ splunk.user }}"
    group: "{{ splunk.group }}"
  when:
    - splunk.role == "splunk_universal_forwarder"
    - socket_file.stat.exists
    - socket_file.stat.size > 0

- name: Configure to set Mgmt Mode as tcp (Allows only TCP)
  ini_file:
    dest: "{{ splunk.home }}/etc/system/local/server.conf"
    option: "mgmtMode"
    section: "httpServer"
    value: "tcp"
    owner: "{{ splunk.user }}"
    group: "{{ splunk.group }}"
  when:
    - splunk.role == "splunk_universal_forwarder"
    - not socket_file.stat.exists or (socket_file.stat.exists and socket_file.stat.size == 0)
